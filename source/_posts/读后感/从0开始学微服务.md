# 从 0 开始学微服务

<!-- TOC depthFrom:2 depthTo:3 -->

- [1. 到底什么是微服务？](#1-到底什么是微服务)
- [2. 从单体应用走向服务化](#2-从单体应用走向服务化)
  - [2.1. 什么时候进行服务化拆分？](#21-什么时候进行服务化拆分)
  - [2.2. 服务化拆分的两种姿势](#22-服务化拆分的两种姿势)
  - [2.3. 服务化拆分的前置条件](#23-服务化拆分的前置条件)
- [3. 初探微服务架构](#3-初探微服务架构)
- [4. 如何发布和引用服务？](#4-如何发布和引用服务)
- [5. 如何注册和发现服务？](#5-如何注册和发现服务)
  - [5.1. 注册中心实现方式](#51-注册中心实现方式)
  - [5.2. 集群部署](#52-集群部署)
  - [5.3. 目录存储](#53-目录存储)
  - [5.4. 服务健康状态检测](#54-服务健康状态检测)
  - [5.5. 服务状态变更通知](#55-服务状态变更通知)
  - [5.6. 白名单机制](#56-白名单机制)
- [6. 如何实现RPC远程服务调用？](#6-如何实现rpc远程服务调用)
- [7. 如何监控微服务调用？](#7-如何监控微服务调用)
- [8. 如何追踪微服务调用？](#8-如何追踪微服务调用)
  - [8.1. 服务追踪的作用](#81-服务追踪的作用)
  - [8.2. 服务追踪系统原理](#82-服务追踪系统原理)
  - [8.3. 服务追踪系统实现](#83-服务追踪系统实现)

<!-- /TOC -->

## 1. 到底什么是微服务？

> 微服务定义
>
> 微服务是由单一应用程序构成的小服务，拥有自己的进程与轻量化处理，服务依业务功能设计，以全自动的方式部署，与其他服务使用 HTTP API 通讯。同时，服务会使用最小规模的集中管理 （例如 Docker）技术，服务可以用不同的编程语言与数据库等。
>
> ——Martin Fowler 和 James Lewis

单体应用的问题

- 部署效率低
- 团队协作开发成本高
- 单点故障问题
- 线上发布变慢

服务化：本地方法调用 转为 远程方法调用（RPC）

微服务和服务化的差异：

- 服务拆分粒度更细
- 服务独立部署、维护
- 服务治理要求高

## 2. 从单体应用走向服务化

### 2.1. 什么时候进行服务化拆分？

经验：开发人员超过10人（沟通成本变高），就可以考虑服务化拆分

### 2.2. 服务化拆分的两种姿势

**纵向拆分**，从业务维度进行拆分。标准是按照业务的关联程度来决定，关联比较密切的业务适合拆分为一个微服务，而功能相对比较独立的业务适合单独拆分为一个微服务。

**横向拆分**，从公共且独立功能维度拆分。标准是按照是否有公共的被多个其他服务调用，且依赖的资源独立不与其他业务耦合。

### 2.3. 服务化拆分的前置条件

- **服务如何定义**。通过接口来约定。
- **服务如何发布和订阅**。通过服务注册和发现。
- **服务如何监控**。**故障如何定位**。服务化需要链路监控。
- **服务如何治理**。超时和重试、流量控制。

## 3. 初探微服务架构

微服务通过注册中心，实现发布订阅模式。

服务调用主要依赖几个基本组件：

- 服务描述：常用的服务描述方式包括 RESTful API、XML 配置以及 IDL 文件三种。
  - RESTful API 代表：Swagger
  - XML 代表：Dubbo
  - IDL 代表：Thrift、gRPC
- 注册中心
  - 服务提供者在启动时，根据服务发布文件中配置的发布信息向注册中心注册自己的服务。
  - 服务消费者在启动时，根据消费者配置文件中配置的服务信息向注册中心订阅自己所需要的服务。
  - 注册中心返回服务提供者地址列表给服务消费者。
  - 当服务提供者发生变化，比如有节点新增或者销毁，注册中心将变更通知给服务消费者。
- 服务框架
  - 通信协议：选择 TCP、UDP、HTTP，还是其他？
  - 数据传输方式：同步、异步、多路复用？
  - 序列化方式：JDK 序列化、Json、二进制（Protobuf、Thrift）？
- 服务监控
  - 数据采集
  - 数据处理
  - 数据展示
- 服务追踪
- 工作原理：通过 requestId、spanId 分别表示一次请求、请求中的某一环节
- 服务治理：
  - 超时、重试
  - 负载均衡
  - 故障转移
  - 流量控制

## 4. 如何发布和引用服务？

**RESTful API**：主要被**用作 HTTP 或者 HTTPS 协议的接口定义**。代表：Eureka

**XML 配置**：代表：Dubbo。工作步骤：

- 服务提供者定义接口，并实现接口。
- 服务提供者进程启动时，通过加载 server.xml 配置文件将接口暴露出去。
- 服务消费者进程启动时，通过加载 client.xml 配置文件来引入要调用的接口。

IDL 文件：IDL 就是接口描述语言（interface description language）的缩写。主要**用作跨语言平台的服务之间的调用**。有两种最常用的 IDL：Thrift、gRPC。

## 5. 如何注册和发现服务？

微服务架构下，主要有三种角色：

- 服务提供者（RPC Server）
- 服务消费者（RPC Client）
- 服务注册中心（Registry）

### 5.1. 注册中心实现方式

注册中心必须提供以下最基本的 API，例如：

- 服务注册接口
- 服务注销接口
- 心跳汇报接口
- 服务订阅接口：服务消费者通过调用服务订阅接口完成服务订阅，获取可用的服务提供者节点列表。
- 服务变更查询接口

- 服务查询接口
- 服务修改接口

### 5.2. 集群部署

注册中心一般都是采用集群部署来保证高可用性，并通过分布式一致性协议来确保集群中不同节点之间的数据保持一致。

以 ZooKeeper 的工作原理为例：

- 每个 Server 在内存中存储了一份数据，Client 的读请求可以请求任意一个 Server。
- ZooKeeper 启动时，将从实例中选举一个 leader（Paxos 协议）。
- Leader 负责处理数据更新等操作（ZAB 协议）。
- 一个更新操作成功，当且仅当大多数 Server 在内存中成功修改 。

### 5.3. 目录存储

注册中心存储服务信息一般采用层次化的目录结构：

- 每个目录在 ZooKeeper 中叫作 znode，并且其有一个唯一的路径标识。
- znode 可以包含数据和子 znode。
- znode 中的数据可以有多个版本，比如某一个 znode 下存有多个数据版本，那么查询这个路径下的数据需带上版本信息。

### 5.4. 服务健康状态检测

ZooKeeper 客户端和服务端维持的是一个长连接。连接成功后，会生成一个全局唯一的 Session ID，客户端定期发送心跳消息，服务端收到后重置会话超时时间。如果超时，则认为连接结束。

如果一个服务将 ZooKeeper 作为服务注册中心，一旦连接超时，ZooKeeper 会认为这个服务节点已经不可用，就会将其信息删除。

### 5.5. 服务状态变更通知

ZooKeeper 支持 Watch 机制。服务消费者可以监听服务提供者的节点信息。一旦服务提供者的节点信息哟变化，就可以获取到变更状态。

### 5.6. 白名单机制

通常注册中心会有多套环境，区分开发、测试、线上等环境。如果弄错了，会出现意想不到的后果，为此需要引入白名单保护机制。只有添加到注册中心白名单内的 RPC Server，才能够调用注册中心的注册接口，这样的话可以避免测试环境中的节点意外跑到线上环境中去。

## 6. 如何实现RPC远程服务调用？

客户端和服务端如何建立网络连接？

- **HTTP 通信**：三次握手建立连接；四次挥手断开连接
- **Socket 通信**
  - 服务器监听
  - 客户端请求
  - 连接确认
  - 数据传输

服务端如何处理请求？

- BIO
- NIO
- AIO

数据传输采用什么协议？

- Http
- Dubbo

数据该如何序列化和反序列化？

- JDK
- JSON
- 二进制（PB、Thrift 等）

## 7. 如何监控微服务调用？

监控对象

- 客户端监控
- 接口监控
- 资源监控
- 基础监控

监控指标

- 请求量
- 响应时间
- 错误率

监控维度

- 全局维度
- 机房维度
- 单机维度
- 时间维度
- 重要性维度

监控关键点

- 数据采集
  - 主动上报
  - 代理收集
- 数据传输
  - UDP
  - Kafka
- 数据处理
  - 全文检索：如 Elasticsearch
  - 时序数据库：如 InfluxDB、OpenTSDB
  - 流计算：如 Spark、Storm、Flink
- 数据展示

## 8. 如何追踪微服务调用？

### 8.1. 服务追踪的作用

- 定位整个系统的瓶颈点
- 优化链路调用
- 生成网络拓扑
- 透明传输数据

### 8.2. 服务追踪系统原理

经典论文：[`Dapper, a Large-Scale Distributed Systems Tracing Infrastructure`](http://bigbully.github.io/Dapper-translation/)

- **traceId**，用于标识某一次具体的请求 ID。当用户的请求进入系统后，会在 RPC 调用网络的第一层生成一个全局唯一的 traceId，并且会随着每一层的 RPC 调用，不断往后传递，这样的话通过 traceId 就可以把一次用户请求在系统中调用的路径串联起来。
- **spanId**，用于标识一次 RPC 调用在分布式请求中的位置。当用户的请求进入系统后，处在 RPC 调用网络的第一层 A 时 spanId 初始值是 0，进入下一层 RPC 调用 B 的时候 spanId 是 0.1，继续进入下一层 RPC 调用 C 时 spanId 是 0.1.1，而与 B 处在同一层的 RPC 调用 E 的 spanId 是 0.2，这样的话通过 spanId 就可以定位某一次 RPC 请求在系统调用中所处的位置，以及它的上下游依赖分别是谁。
- **annotation**，用于业务自定义埋点数据，可以是业务感兴趣的想上传到后端的数据，比如一次请求的用户 UID。

### 8.3. 服务追踪系统实现

服务追踪系统可以分为三层。

- 数据采集层，负责数据埋点并上报。
- 数据处理层，负责数据的存储与计算。
- 数据展示层，负责数据的图形化展示。

## 微服务治理的手段有哪些？

服务调用失败原因：

- 服务提供者自身问题，如宕机、进程退出等；
- 网络问题

### 节点管理

- **注册中心主动摘除机制**：服务提供者定时发送心跳，如果超时，注册中心把节点从服务列表中删除
- **服务消费者摘除机制**：如果服务消费者调用服务提供者节点失败，就将这个节点从内存中保存的可用服务提供者节点列表中移除。

### 负载均衡

- 随机算法
- 轮询算法
- 最少活跃调用算法
- 一致性 Hash 算法

### 服务路由

为什么要制定路由规则呢？

- 业务存在灰度发布的需求
- 多机房就近访问的需求

如何配置路由规则

- 静态配置：修改服务消费者本地配置，上线后生效
- 动态配置：修改注册中心的配置，服务消费者在下一个同步周期之后，就会动态更新

### 服务容错

- FailOver：失败自动切换。
- FailBack：失败通知。
- FailCache：失败缓存。
- FailFast：快速失败。

一般情况下对于幂等的调用，可以选择 FailOver 或者 FailCache，非幂等的调用可以选择 FailBack 或者 FailFast。

## Dubbo框架里的微服务组件

## 服务发布和引用的实践

XML 配置方式的服务发布和引用流程

- 服务提供者定义接口
- 服务提供者发布接口
- 服务消费者引用接口

服务发布和引用的那些坑

## 如何将注册中心落地？

注册中心如何存储服务信息

服务一般会分成多个不同的分组

- 核心与非核心，从业务的核心程度来分。
- 机房，从机房的维度来分。
- 线上环境与测试环境，从业务场景维度来区分。

所以注册中心存储的服务信息一般包含三部分内容：**分组**、**服务名**以及**节点信息**，节点信息又包括节点地址和节点其他信息。

### 注册中心工作流程

- 服务提供者注册流程。
- 服务提供者反注册流程。
- 服务消费者查询流程。
- 服务消费者订阅变更流程。

### 如何注册节点

- 首先查看要注册的节点是否在白名单内？如果不在就抛出异常，在的话继续下一步。
- 其次要查看注册的 Cluster（服务的接口名）是否存在？如果不存在就抛出异常，存在的话继续下一步。
- 然后要检查 Service（服务的分组）是否存在？如果不存在则抛出异常，存在的话继续下一步。
- 最后将节点信息添加到对应的 Service 和 Cluster 下面的存储中。

### 如何反注册

- 查看 Service（服务的分组）是否存在，不存在就抛出异常，存在就继续下一步。
- 查看 Cluster（服务的接口名）是否存在，不存在就抛出异常，存在就继续下一步。
- 删除存储中 Service 和 Cluster 下对应的节点信息。
- 更新 Cluster 的 sign 值。

### 如何查询节点信息

首先从 localcache（本机内存）中查找，如果没有就继续下一步。

接着从 snapshot（本地快照）中查找，如果没有就继续下一步。

### 如何订阅服务变更

- 服务消费者从注册中心获取了服务的信息后，就订阅了服务的变化，会在本地保留 Cluster 的 sign 值。
- 服务消费者每隔一段时间，调用 getSign() 函数，从注册中心获取服务端该 Cluster 的 sign 值，并与本地保留的 sign 值做对比，如果不一致，就从服务端拉取新的节点信息，并更新 localcache 和 snapshot。

### 注册与发现的几个问题

多注册中心

并行订阅服务
